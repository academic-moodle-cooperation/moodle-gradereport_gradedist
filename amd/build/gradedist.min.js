define(["jquery","core/log","core/str"],function(a,b,c){var d=function(){};d.prototype.update=function(b){var c=JSON.parse(b.responseText);if(1==c.updateall){window.absolut=[],window.percent=[],a.map(c.actdist,function(a){window.absolut.push(a.count),window.percent.push(a.percentage)});var d=1==window.mode?window.percent:window.absolut;window.chart.series[0].setData(d),window.chart.setTitle({text:c.title})}window.absolutnew=[],window.percentnew=[],a.map(c.newdist,function(a){window.absolutnew.push(a.count),window.percentnew.push(a.percentage)}),e.coverage(c);var f=1==window.mode?window.percentnew:window.absolutnew;return window.chart.series[1].setData(f),!0},d.prototype.validate=function(){var b=!1,d=!1,e=!1,f=!1,g=!1,h=a("#b_decimals").first(),i=a("#b_interval").first(),j=a("#b_predecessor").first(),k=/^\d+([.]\d{1,2})?$/,l=100.01;return a.each(window.boundaries,function(a,b){var c=b.value.replace(/,/g,".");""!=c?(k.test(c)||(d=!0),Number(c)>100&&(e=!0),Number(c)>=Number(l)&&(f=!0),l=c):g=!0}),d?(h.length||c.get_string("decimals","gradereport_gradedist").done(function(b){a("#boundary_error_container").first().append('<div class="b_error" id="b_decimals"><span>'+b+"</span></div>")}),b=!0):h.length&&h.remove(),e?(i.length||c.get_string("interval","gradereport_gradedist").done(function(b){a("#boundary_error_container").first().append('<div class="b_error" id="b_interval"><span>'+b+"</span></div>")}),b=!0):i.length&&i.remove(),f?(j.length||c.get_string("predecessor","gradereport_gradedist").done(function(b){a("#boundary_error_container").first().append('<div class="b_error" id="b_predecessor"><span>'+b+"</span></div>")}),b=!0):j.length&&j.remove(),window.submit.length&&window.submit.prop("disabled",b||g),!b},d.prototype.coverage=function(b){var d=!1,e=!1,f=0!=Number(b.newcoverage[0]),g=a("#b_coverage").first();return a.each(window.boundaries,function(a,b){""==b.value&&(e=!0)}),!e&&f?(g.length||c.get_string("coverage","gradereport_gradedist").done(function(c){a("#boundary_error_container").first().append('<div class="b_error" id="b_coverage"><span>'+c+'</span><span class="newcoverage">'+b.newcoverage[0]+"/"+b.newcoverage[1]+"</span></div>")}),d=!0):g.length&&g.remove(),a(".actcoverage").html(b.actcoverage[0]+"/"+b.actcoverage[1]+" ("+b.actcoverage[2]+"%)"),a(".newcoverage").html(b.newcoverage[0]+"/"+b.newcoverage[1]+" ("+b.newcoverage[2]+"%)"),!d},d.prototype.initChart=function(a,b,d){var e=[{key:"gradeletter",component:"gradereport_gradedist"},{key:"absolut",component:"gradereport_gradedist"},{key:"percent",component:"gradereport_gradedist"},{key:"printchart",component:"gradereport_gradedist"},{key:"downloadpng",component:"gradereport_gradedist"},{key:"downloadjpeg",component:"gradereport_gradedist"},{key:"downloadpdf",component:"gradereport_gradedist"},{key:"downloadsvg",component:"gradereport_gradedist"},{key:"downloadjpeg",component:"gradereport_gradedist"},{key:"contextbuttontitle",component:"gradereport_gradedist"}];c.get_strings(e).done(function(c){window.chart=new d.Chart({chart:{renderTo:"chart_container",type:"column"},title:{text:a.title},xAxis:{title:{text:c[0]},categories:b},yAxis:{title:{text:c[1]}},legend:{enabled:!1},tooltip:{enabled:!1},lang:{printChart:c[3],downloadPNG:c[4],downloadJPEG:c[5],downloadPDF:c[6],downloadSVG:c[7],contextButtonTitle:c[8]},series:[{data:window.absolut,color:"#990000",dataLabels:{enabled:!0,color:"#000000",style:{fontWeight:"normal"}}},{data:window.absolutnew,color:"#33cc33",dataLabels:{enabled:!0,color:"#000000",style:{fontWeight:"normal"}}}]})})};var e=new d;return e.initializer=function(d){b.info("Initialize settings JS","gradedist");var f=d.data;window.mode=0;var g=[];window.absolut=[],window.percent=[],window.absolutnew=[],window.percentnew=[];var h="#id_submitbutton";if(window.submit=a(h),window.submit.length&&window.submit.prop("disabled",!0),a.map(f.actdist,function(a,b){g.push(b),window.absolut.push(a.count),window.percent.push(a.percentage)}),a.map(f.newdist,function(a){window.absolutnew.push(a.count),window.percentnew.push(a.percentage)}),window.chart=[],f.highcharts_src)require(["gradereport_gradedist/define_hc_src"],function(a){e.initChart(f,g,a)});else if(f.highcharts_min)require(["gradereport_gradedist/define_hc_min"],function(a){e.initChart(f,g,a)});else{var i="#chart_container";c.get_string("highchartsmissing","gradereport_gradedist").done(function(b){a(i).first().html("<br><p><i><strong>[ !!! "+b+" !!! ]</strong></i></p><br>")})}var j=M.cfg.wwwroot+"/grade/report/gradedist/ajax_handler.php?id="+f.courseid,k={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},complete:function(a){e.update(a)},url:j},l="#id_gradeitem",m=a(l).first();m.change(e,function(){var b=a(".alert-success");b&&b.remove(),k.data=a("#letterform").serialize()+"&updateall=1",a.ajax(k)});var n="#id_coursegroup",o=a(n).first();o&&o.change(e,function(){var b=a(".alert-success");b&&b.remove(),a("#id_coursegrouping").first().prop("value","0"),k.data=a("#letterform").serialize()+"&updateall=1",a.ajax(k)});var p="#id_coursegrouping",q=a(p).first();q&&q.change(e,function(){var b=a(".alert-success");b&&b.remove(),a("#id_coursegroup").first().prop("value","0"),k.data=a("#letterform").serialize()+"&updateall=1",a.ajax(k)}),window.boundaries=a(".gradeboundaries_new input[type=text], #fgroup_id_grp_gradeboundaries_new input[type=text]"),window.boundaries.change(e,function(){var b=a("#page-grade-report-gradedist-index .notifyproblem, #page-grade-report-gradedist-index .notifysuccess");b&&b.remove();var c=a(".alert-success");c&&c.remove(),e.validate()&&(k.data=a("#letterform").serialize()+"&updateall=1",a.ajax(k))});var r=a('input[name^="grp_description"]');r.change(e,function(){window.mode=this.value;var a,b,d,e;1==window.mode?(a=window.percent,b=window.percentnew,d="percent",e=100):(a=window.absolut,b=window.absolutnew,d="absolut",e=null),c.get_string(d,"gradereport_gradedist").done(function(c){window.chart.yAxis[0].axisTitle.attr({text:c}),window.chart.yAxis[0].setExtremes(0,e),window.chart.series[0].setData(a),window.chart.series[1].setData(b)})});var s=a("#id_grp_columns_actualcolumns, #id_grp_columns_newcolumns");s.click(e,function(){var a="id_grp_columns_actualcolumns"===this.id?0:1;this.checked?window.chart.series[a].show():window.chart.series[a].hide()}),e.validate()},e});