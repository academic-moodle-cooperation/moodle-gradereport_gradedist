define(["jquery","core/log","core/str","core/chartjs"],function(a,b,c,d){var e=function(){};e.prototype.update=function(b){var c=JSON.parse(b.responseText);if(1==c.updateall){window.absolut=[],window.percent=[],a.map(c.actdist,function(a){window.absolut.push(a.count),window.percent.push(a.percentage)});var d=1==window.mode?window.percent:window.absolut;window.chart.data.datasets[0].data=d,window.chart.options.title.text=[c.title,""]}window.absolutnew=[],window.percentnew=[],a.map(c.newdist,function(a){window.absolutnew.push(a.count),window.percentnew.push(a.percentage)}),f.coverage(c);var e=1==window.mode?window.percentnew:window.absolutnew;return window.chart.data.datasets[1].data=e,window.chart.update(),!0},e.prototype.validate=function(){var b=!1,d=!1,e=!1,f=!1,g=!1,h=a("#b_decimals").first(),i=a("#b_interval").first(),j=a("#b_predecessor").first(),k=/^\d+([.]\d{1,2})?$/,l=100.01;return a.each(window.boundaries,function(a,b){var c=b.value.replace(/,/g,".");""!=c?(k.test(c)||(d=!0),Number(c)>100&&(e=!0),Number(c)>=Number(l)&&(f=!0),l=c):g=!0}),d?(h.length||c.get_string("decimals","gradereport_gradedist").done(function(b){a("#boundary_error_container").first().append('<div class="b_error" id="b_decimals"><span>'+b+"</span></div>")}),b=!0):h.length&&h.remove(),e?(i.length||c.get_string("interval","gradereport_gradedist").done(function(b){a("#boundary_error_container").first().append('<div class="b_error" id="b_interval"><span>'+b+"</span></div>")}),b=!0):i.length&&i.remove(),f?(j.length||c.get_string("predecessor","gradereport_gradedist").done(function(b){a("#boundary_error_container").first().append('<div class="b_error" id="b_predecessor"><span>'+b+"</span></div>")}),b=!0):j.length&&j.remove(),window.submit.length&&window.submit.prop("disabled",b||g),!b},e.prototype.coverage=function(b){var d=!1,e=!1,f=0!=Number(b.newcoverage[0]),g=a("#b_coverage").first();return a.each(window.boundaries,function(a,b){""==b.value&&(e=!0)}),!e&&f?(g.length||c.get_string("coverage","gradereport_gradedist").done(function(c){a("#boundary_error_container").first().append('<div class="b_error" id="b_coverage"><span>'+c+'</span><span class="newcoverage">'+b.newcoverage[0]+"/"+b.newcoverage[1]+"</span></div>")}),d=!0):g.length&&g.remove(),a(".actcoverage").html(b.actcoverage[0]+"/"+b.actcoverage[1]+" ("+b.actcoverage[2]+"%)"),a(".newcoverage").html(b.newcoverage[0]+"/"+b.newcoverage[1]+" ("+b.newcoverage[2]+"%)"),!d},e.prototype.initChart=function(b,e){var f=[{key:"gradeletter",component:"gradereport_gradedist"},{key:"absolut",component:"gradereport_gradedist"},{key:"percent",component:"gradereport_gradedist"},{key:"printchart",component:"gradereport_gradedist"},{key:"downloadpng",component:"gradereport_gradedist"},{key:"downloadjpeg",component:"gradereport_gradedist"},{key:"downloadpdf",component:"gradereport_gradedist"},{key:"downloadsvg",component:"gradereport_gradedist"},{key:"downloadjpeg",component:"gradereport_gradedist"},{key:"contextbuttontitle",component:"gradereport_gradedist"}];c.get_strings(f).done(function(c){window.chart=new d(a("#chart_container"),{type:"bar",data:{labels:e,datasets:[{data:window.absolut,backgroundColor:"#990000",borderWidth:1},{data:window.absolutnew,backgroundColor:"#33cc33",borderWidth:1}]},options:{title:{display:!0,text:[b.title,""],fontSize:18,fontStyle:"normal"},scales:{yAxes:[{ticks:{beginAtZero:!0,padding:10},scaleLabel:{display:!0,labelString:c[1],fontColor:"#4d759e",fontSize:15},gridLines:{drawBorder:!1,lineWidth:.5,color:"#000000",zeroLineColor:"#c0e0d0"}}],xAxes:[{scaleLabel:{display:!0,labelString:c[0],fontColor:"#4d759e",fontSize:15},gridLines:{drawOnChartArea:!1},barPercentage:.8}]},legend:{display:!1},plugins:{datalabels:{anchor:"end",align:"top",color:"#000000"}}}})})};var f=new e;return f.initializer=function(d){b.info("Initialize settings JS","gradedist");var e=d.data;window.mode=0;var g=[];window.absolut=[],window.percent=[],window.absolutnew=[],window.percentnew=[];var h="#id_submitbutton";window.submit=a(h),window.submit.length&&window.submit.prop("disabled",!0),a.map(e.actdist,function(a,b){g.push(b),window.absolut.push(a.count),window.percent.push(a.percentage)}),a.map(e.newdist,function(a){window.absolutnew.push(a.count),window.percentnew.push(a.percentage)}),window.chart=[],require(["gradereport_gradedist/define_chart"],function(a){a.plugins.register({beforeDraw:function(a){var b=a.chart.ctx;b.fillStyle="white",b.fillRect(0,0,a.chart.width,a.chart.height)}}),require(["gradereport_gradedist/define_datalabels"],function(){f.initChart(e,g)})});var i=M.cfg.wwwroot+"/grade/report/gradedist/ajax_handler.php?id="+e.courseid,j={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},complete:function(a){f.update(a)},url:i},k="#id_gradeitem",l=a(k).first();l.change(f,function(){var b=a(".alert-success");b&&b.remove(),j.data=a("#letterform").serialize()+"&updateall=1",a.ajax(j)});var m="#id_coursegroup",n=a(m).first();n&&n.change(f,function(){var b=a(".alert-success");b&&b.remove(),a("#id_coursegrouping").first().prop("value","0"),j.data=a("#letterform").serialize()+"&updateall=1",a.ajax(j)});var o="#id_coursegrouping",p=a(o).first();p&&p.change(f,function(){var b=a(".alert-success");b&&b.remove(),a("#id_coursegroup").first().prop("value","0"),j.data=a("#letterform").serialize()+"&updateall=1",a.ajax(j)}),window.boundaries=a(".gradeboundaries_new input[type=text], #fgroup_id_grp_gradeboundaries_new input[type=text]"),window.boundaries.change(f,function(){var b=a("#page-grade-report-gradedist-index .notifyproblem, #page-grade-report-gradedist-index .notifysuccess");b&&b.remove();var c=a(".alert-success");c&&c.remove(),f.validate()&&(j.data=a("#letterform").serialize()+"&updateall=1",a.ajax(j))});var q=a('input[name^="grp_description"]');q.change(f,function(){window.mode=this.value;var a,b,d,e;1==window.mode?(a=window.percent,b=window.percentnew,d="percent",e=100):(a=window.absolut,b=window.absolutnew,d="absolut",e=Math.max(Math.max.apply(this,window.absolut),Math.max.apply(this,window.absolutnew))),c.get_string(d,"gradereport_gradedist").done(function(c){window.chart.options.scales.yAxes[0].scaleLabel.labelString=c,window.chart.options.scales.yAxes[0].ticks.suggestedMax=e,window.chart.data.datasets[0].data=a,window.chart.data.datasets[1].data=b,window.chart.update()})});var r=a("#id_grp_columns_actualcolumns, #id_grp_columns_newcolumns");r.click(f,function(){var a="id_grp_columns_actualcolumns"===this.id?0:1;this.checked?(window.chart.data.datasets[a].hidden=!1,window.chart.update()):(window.chart.data.datasets[a].hidden=!0,window.chart.update())});var s=a('input[name^="grp_to_image"]');s.change(f,function(){require(["gradereport_gradedist/define_html2pdf"],function(a){var b=document.getElementById("chart_container"),c={margin:1,filename:"myfile.pdf",image:{type:"jpeg",quality:.98},jsPDF:{unit:"px",format:[1e3,400],orientation:"landscape"}};a(b,c)})}),f.validate()},f});